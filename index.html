<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Auto MP3 folder loader — Dark Player</title>
<meta name="description" content="Auto-load all .mp3 in same folder (GitHub Pages friendly)">
<style>
:root{--bg:#071019;--muted:#98a4ad;--accent:#1db954;--text:#e8f0f4;--card:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));--radius:12px}
*{box-sizing:border-box}html,body{height:100%;margin:0;background:linear-gradient(180deg,#041018,#071019);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
.app{display:grid;grid-template-columns:360px 1fr;gap:16px;height:100vh;padding:18px}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 8px 30px rgba(2,6,10,0.6);border:1px solid rgba(255,255,255,0.02)}
.cover{height:300px;border-radius:10px;overflow:hidden;background:linear-gradient(180deg,#0b0f12,#071018);display:flex;align-items:center;justify-content:center}
.cover img{width:100%;height:100%;object-fit:cover}
.controls{display:flex;gap:10px;align-items:center;margin-top:12px}
.btn{background:transparent;border:0;padding:10px;border-radius:10px;color:var(--text);cursor:pointer}
.play{width:62px;height:62px;border-radius:12px;background:linear-gradient(180deg,var(--accent),#16a84a);border:0;cursor:pointer;font-weight:700;font-size:18px}
.seek-wrap{margin-top:12px}
input[type=range]{width:100%}
.panel{padding:12px}
.playlist{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:10px;padding:8px;overflow:auto;height:calc(100vh - 220px)}
.track{display:grid;grid-template-columns:56px 1fr 80px;gap:12px;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
.track:hover{background:rgba(255,255,255,0.02)}
.track.active{background:linear-gradient(90deg, rgba(29,185,84,0.06), rgba(29,185,84,0.02))}
.muted{color:var(--muted);font-size:13px;margin-top:8px}
.remote{margin-top:10px;display:flex;gap:8px}
input[type=text], textarea{background:#061118;border:1px solid rgba(255,255,255,0.02);color:var(--text);padding:8px;border-radius:8px;width:100%}
textarea{min-height:60px;resize:vertical}
@media(max-width:900px){.app{grid-template-columns:1fr;}}
</style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="cover"><img id="coverImg" alt="cover"/></div>
      <div style="margin-top:10px"><div id="trackTitle" style="font-weight:700">No track</div><div class="muted" id="artistLabel">Siva Manihandan</div></div>

      <div class="controls">
        <button id="prev" class="btn">⏮</button>
        <button id="play" class="play">▶</button>
        <button id="next" class="btn">⏭</button>
        <div style="flex:1"></div>
        <div class="muted" id="count">0 tracks</div>
      </div>

      <div class="seek-wrap">
        <input id="seek" type="range" min="0" max="100" value="0"/>
        <div style="display:flex;justify-content:space-between;color:var(--muted);font-size:13px"><span id="cur">0:00</span><span id="dur">0:00</span></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <label style="color:var(--muted)"><input id="shuffle" type="checkbox" /> Shuffle</label>
        <label style="color:var(--muted)"><input id="repeat" type="checkbox" /> Repeat</label>
        <div style="flex:1"></div>
        <div id="status" class="muted">Detecting .mp3 files in folder...</div>
      </div>
    </div>

    <div class="panel">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <input id="filter" type="text" placeholder="Filter tracks..." />
        <button id="import" class="btn">⤓</button>
      </div>

      <div class="remote">
        <input id="manualBase" type="text" placeholder="Base URL (leave blank for same folder)" />
        <button id="manualLoad" class="btn">Load</button>
      </div>
      <div class="muted" style="margin-top:8px">If auto fails, paste a base raw URL (e.g. raw.githubusercontent...) and click Load — otherwise just host public on GitHub Pages in same folder and this will try Github API automatically.</div>

      <div class="playlist" id="playlist"></div>
    </div>
  </div>

  <div style="position:fixed;left:18px;right:18px;bottom:18px;height:64px;background:#071017;border-radius:12px;padding:10px;display:flex;align-items:center;gap:12px;box-shadow:0 18px 50px rgba(2,6,10,0.6)">
    <div style="width:56px;height:56px;border-radius:8px;overflow:hidden"><img id="miniImg" style="width:100%;height:100%;object-fit:cover"></div>
    <div style="flex:1;min-width:0">
      <div id="miniTitle" style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">No track</div>
      <div class="muted" id="miniArtist">Siva Manihandan</div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="mPrev" class="btn">⏮</button>
      <button id="mPlay" class="play">▶</button>
      <button id="mNext" class="btn">⏭</button>
    </div>
  </div>

  <audio id="audio" preload="metadata"></audio>

<script>
/* Simplified single-file: find all .mp3 in same folder and display them.
   Strategy (in order):
   1) Try fetch('./') and parse links (if host returns directory listing)
   2) If host looks like GitHub Pages or raw.githubusercontent.com, call GitHub API (public repo only)
   3) If manual base provided by user, use that.
   If none works, show status message.
*/

const AUDIO_RE = /\.mp3(\?.*)?$/i;
const DEFAULT_ARTIST = 'Siva Manihandan';

const audio = document.getElementById('audio');
const playlistEl = document.getElementById('playlist');
const playBtn = document.getElementById('play');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const seek = document.getElementById('seek');
const cur = document.getElementById('cur');
const dur = document.getElementById('dur');
const count = document.getElementById('count');
const statusEl = document.getElementById('status');
const filterInput = document.getElementById('filter');

const miniImg = document.getElementById('miniImg');
const miniTitle = document.getElementById('miniTitle');
const miniArtist = document.getElementById('miniArtist');
const mPlay = document.getElementById('mPlay');
const mPrev = document.getElementById('mPrev');
const mNext = document.getElementById('mNext');

let tracks = []; // {name, url, thumb, duration}
let current = -1;
let isShuffle = false;
let isRepeat = false;
let autoplay = true;
audio.volume = 1;

document.getElementById('import').addEventListener('click', ()=> {
  const inp = document.createElement('input'); inp.type='file'; inp.multiple=true; inp.accept='.mp3'; inp.onchange = ()=> { if(inp.files) handleFiles(inp.files); }; inp.click();
});
document.getElementById('manualLoad').addEventListener('click', ()=> {
  const base = document.getElementById('manualBase').value.trim();
  if(!base){ statusEl.textContent='Enter base URL or host directory must be accessible.'; return; }
  loadFromManualBase(base);
});
document.getElementById('shuffle').addEventListener('change', e=> isShuffle = e.target.checked);
document.getElementById('repeat').addEventListener('change', e=> isRepeat = e.target.checked);

filterInput.addEventListener('input', ()=> render(filterInput.value));

// format time carefully
function fmtTime(s){ if(isNaN(s)||!isFinite(s)) return '0:00'; const m=Math.floor(s/60); const sec=Math.floor(s%60).toString().padStart(2,'0'); return m+':'+sec; }

// thumbnail simple deterministic initials
function makeThumb(name){
  const initials = name.split(/[\s\-_]+/).map(p=>p[0]||'').slice(0,2).join('').toUpperCase() || 'S';
  const color = ['#1db954','#ff6b6b','#6b8bff','#9b6bff'][Math.abs(hashCode(name))%4];
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='100%' height='100%' fill='${color}'/><text x='50%' y='55%' font-size='140' text-anchor='middle' fill='white' font-family='Arial' font-weight='700'>${initials}</text></svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}
function hashCode(s){ let h=0; for(let i=0;i<s.length;i++){ h = ((h<<5)-h) + s.charCodeAt(i); h |= 0; } return h; }

// render playlist
function render(filter=''){
  playlistEl.innerHTML = '';
  const filtered = tracks.filter(t => (t.name+' '+(t.artist||'')).toLowerCase().includes(filter.toLowerCase()));
  filtered.forEach((t, idx) => {
    const i = tracks.indexOf(t);
    const div = document.createElement('div');
    div.className = 'track' + (i===current ? ' active' : '');
    div.dataset.index = i;
    div.innerHTML = `<div style="width:56px;height:56px;border-radius:8px;overflow:hidden"><img src="${t.thumb}" style="width:100%;height:100%;object-fit:cover"></div>
      <div style="min-width:0"><div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(t.name)}</div><div style="color:#98a4ad;font-size:12px">${escapeHtml(t.artist||DEFAULT_ARTIST)}</div></div>
      <div style="text-align:right;color:#98a4ad">${t.duration?fmtTime(t.duration):''}</div>`;
    div.addEventListener('click', ()=> playIndex(i));
    playlistEl.appendChild(div);
  });
  count.textContent = tracks.length + ' tracks';
  updateMini();
}

function escapeHtml(s){ return String(s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }

function updateMini(){
  const t = tracks[current];
  miniTitle.textContent = t? t.name : 'No track';
  miniArtist.textContent = t? (t.artist||DEFAULT_ARTIST) : DEFAULT_ARTIST;
  miniImg.src = t? t.thumb : '';
  mPlay.textContent = audio.paused ? '▶' : '⏸';
  playBtn.textContent = audio.paused ? '▶' : '⏸';
}

// play logic
function playIndex(i){
  if(tracks.length===0) return;
  if(i<0) i=0;
  if(i>=tracks.length) i=0;
  current = i;
  const t = tracks[current];
  audio.src = t.url;
  document.getElementById('trackTitle').textContent = t.name;
  document.getElementById('artistLabel').textContent = t.artist || DEFAULT_ARTIST;
  audio.play().catch(()=>{});
  render(filterInput.value);
}
function nextTrack(){
  if(isRepeat){ audio.currentTime = 0; audio.play(); return; }
  if(isShuffle){ playIndex(Math.floor(Math.random()*tracks.length)); return; }
  playIndex((current + 1) % tracks.length);
}
function prevTrack(){
  if(audio.currentTime > 3){ audio.currentTime = 0; audio.play(); return; }
  playIndex(Math.max(0, current-1));
}

playBtn.addEventListener('click', ()=> {
  if(!audio.src && tracks.length) { playIndex(0); return; }
  if(audio.paused){ audio.play(); playBtn.textContent='⏸'; mPlay.textContent='⏸'; } else { audio.pause(); playBtn.textContent='▶'; mPlay.textContent='▶'; }
});
mPlay.addEventListener('click', ()=> playBtn.click());
prevBtn.addEventListener('click', prevTrack);
mPrev.addEventListener('click', prevTrack);
nextBtn.addEventListener('click', nextTrack);
mNext.addEventListener('click', nextTrack);

audio.addEventListener('timeupdate', ()=> {
  if(audio.duration){ seek.value = (audio.currentTime / audio.duration) * 100; cur.textContent = fmtTime(audio.currentTime); dur.textContent = fmtTime(audio.duration); }
});
audio.addEventListener('loadedmetadata', ()=> {
  if(audio.duration && tracks[current]){ tracks[current].duration = audio.duration; render(filterInput.value); }
});
audio.addEventListener('ended', ()=> { if(autoplay) nextTrack(); else { playBtn.textContent='▶'; mPlay.textContent='▶'; } });

seek.addEventListener('input', ()=> { if(audio.duration) audio.currentTime = (seek.value/100)*audio.duration; });

// --- detection methods ---
// 1) Try directory listing parse of './'
async function tryDirectoryListing(){
  try{
    const r = await fetch('./', {cache:'no-store'});
    if(!r.ok) return false;
    const text = await r.text();
    // quick parse of <a href="..."> links
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');
    const anchors = Array.from(doc.getElementsByTagName('a')).map(a=>a.getAttribute('href')||'');
    const mp3s = anchors.filter(h => AUDIO_RE.test(h)).map(h => (h.startsWith('http') ? h : (h)));
    if(mp3s.length){
      tracks = mp3s.map(u => {
        const name = decodeURIComponent(u.split('/').pop()).replace(/\.mp3(\?.*)?$/i,'');
        return { name, url: u, thumb: makeThumb(name), artist: DEFAULT_ARTIST };
      });
      await populateDurations();
      statusEl.textContent = 'Loaded from server directory listing.';
      return true;
    }
  }catch(e){}
  return false;
}

// 2) Try GitHub API when hosted under github pages or raw.githubusercontent
async function tryGithubApi(){
  try{
    const host = location.hostname.toLowerCase();
    if(host === 'raw.githubusercontent.com'){
      // raw path: /owner/repo/branch/path/...
      const parts = location.pathname.split('/').filter(Boolean);
      if(parts.length >= 3){
        const owner = parts[0], repo = parts[1], branch = parts[2];
        const path = parts.slice(3).join('/');
        return await listGithubContents(owner, repo, path, branch);
      }
    }
    if(host.endsWith('github.io')){
      // owner from hostname
      const owner = host.split('.')[0];
      const pathParts = location.pathname.split('/').filter(Boolean);
      // if pathParts[0] exists, it might be project pages: username.github.io/repo/...
      const guesses = [];
      if(pathParts.length>0) guesses.push({owner, repo: pathParts[0], path: pathParts.slice(1).join('')});
      // also try user site repo
      guesses.push({owner, repo: owner + '.github.io', path: pathParts.join('/')});
      // try common branches
      for(const g of guesses){
        for(const branch of ['gh-pages','main','master']){
          const ok = await listGithubContents(g.owner||g.owner, g.repo, g.path, branch);
          if(ok) return true;
        }
      }
    }
  }catch(e){}
  return false;
}
async function listGithubContents(owner, repo, path, branch='gh-pages'){
  try{
    // ensure path doesn't start with slash
    const cleanPath = (path||'').replace(/^\/+|\/+$/g,'');
    const api = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(cleanPath)}?ref=${encodeURIComponent(branch)}`;
    const r = await fetch(api, {headers: { 'Accept': 'application/vnd.github.v3+json' }});
    if(!r.ok) return false;
    const json = await r.json();
    if(!Array.isArray(json)) return false;
    const files = json.filter(item => item.type === 'file' && AUDIO_RE.test(item.name));
    if(!files.length) return false;
    tracks = files.map(f => ({ name: f.name.replace(/\.mp3$/i,''), url: f.download_url, thumb: makeThumb(f.name.replace(/\.mp3$/i,'')), artist: DEFAULT_ARTIST }));
    await populateDurations();
    statusEl.textContent = `Loaded ${tracks.length} mp3(s) from GitHub repo ${owner}/${repo}${path?('/'+path):''} (branch ${branch}).`;
    return true;
  }catch(e){ return false; }
}

// 3) Manual base loader
async function loadFromManualBase(base){
  try{
    // try fetching base (if it returns listing)
    if(!base.match(/^https?:\/\//i)) base = location.origin + (base.startsWith('/')? base : '/' + base);
    // if base returns directory listing parse
    const r = await fetch(base, {cache:'no-store'});
    if(r.ok){
      const text = await r.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      const anchors = Array.from(doc.getElementsByTagName('a')).map(a=>a.getAttribute('href')||'');
      const mp3s = anchors.filter(h => AUDIO_RE.test(h)).map(h => {
        if(/^https?:\/\//i.test(h)) return h;
        // make absolute
        return base.endsWith('/')? base + h : base + '/' + h;
      });
      if(mp3s.length){
        tracks = mp3s.map(u => ({ name: decodeURIComponent(u.split('/').pop()).replace(/\.mp3(\?.*)?$/i,''), url: u, thumb: makeThumb(u.split('/').pop().replace(/\.mp3(\?.*)?$/i,'')), artist: DEFAULT_ARTIST }));
        await populateDurations();
        statusEl.textContent = 'Loaded mp3s from provided base URL directory listing.';
        render();
        return true;
      }
    }
    // otherwise, assume user pointed to a raw folder without listing -> fail and ask them to provide raw file links
    statusEl.textContent = 'No directory listing at base URL. Provide raw file URLs or use GitHub Pages public site.';
  }catch(e){
    statusEl.textContent = 'Error loading from base URL.';
  }
  render();
}

// helper to get durations for each track (so UI shows time)
async function populateDurations(){
  const promises = tracks.map(t => new Promise(resolve => {
    const a = document.createElement('audio');
    a.preload = 'metadata';
    a.src = t.url;
    const onmeta = ()=> { if(!isNaN(a.duration) && isFinite(a.duration)) t.duration = a.duration; a.remove(); resolve(t); };
    const onerr = ()=> { a.remove(); resolve(t); };
    a.addEventListener('loadedmetadata', onmeta, {once:true});
    a.addEventListener('error', onerr, {once:true});
    a.load();
    setTimeout(()=>{ resolve(t); try{ a.remove(); }catch(e){} }, 5000);
  }));
  await Promise.all(promises);
  render();
}

// escape html helper
function escapeHtml(s){ return String(s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }

// file input handler
function handleFiles(fileList){
  const files = Array.from(fileList).filter(f => AUDIO_RE.test(f.name));
  if(!files.length) { statusEl.textContent = 'No mp3 files selected.'; return; }
  tracks.forEach(t => { if(t._blob) URL.revokeObjectURL(t.url); });
  tracks = files.map(f => ({ name: f.name.replace(/\.mp3$/i,''), url: URL.createObjectURL(f), artist: DEFAULT_ARTIST, thumb: makeThumb(f.name.replace(/\.mp3$/i,'')), _blob:true }));
  populateDurations();
  statusEl.textContent = 'Loaded local files (drag & drop or file picker).';
}

document.body.addEventListener('drop', e => { e.preventDefault(); if(e.dataTransfer && e.dataTransfer.files) handleFiles(e.dataTransfer.files); });
document.body.addEventListener('dragover', e => e.preventDefault());

// small keyboard shortcuts
window.addEventListener('keydown', e => { if(e.code==='Space'){ e.preventDefault(); playBtn.click(); } if(e.code==='ArrowRight') nextTrack(); if(e.code==='ArrowLeft') prevTrack(); });

// attempt auto-detection sequence
(async function autoDetect(){
  statusEl.textContent = 'Trying directory listing in same folder...';
  let ok = await tryDirectoryListing();
  if(ok) return;
  statusEl.textContent = 'Trying GitHub API (public GitHub Pages)...';
  ok = await tryGithubApi();
  if(ok) return;
  statusEl.textContent = 'Auto-detect failed — paste base URL or use import (drag & drop).';
})();

// small UI helpers for play controls exposed earlier
function makeThumb(name){
  const initials = name.split(/[\s\-_]+/).map(p=>p[0]||'').slice(0,2).join('').toUpperCase()||'S';
  const color = ['#1db954','#ff6b6b','#6b8bff','#9b6bff'][Math.abs(hashCode(name))%4];
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='100%' height='100%' fill='${color}'/><text x='50%' y='55%' font-size='140' text-anchor='middle' fill='white' font-family='Arial' font-weight='700'>${initials}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function hashCode(s){ let h=0; for(let i=0;i<s.length;i++){ h = ((h<<5)-h) + s.charCodeAt(i); h|=0; } return h; }

</script>
</body>
</html>
