<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>MP3 Player — Clean / Spotify-like</title>
<meta name="description" content="Clean dark MP3 player — auto-loads mp3 from repo root">
<style>
:root{
  --max-w:1100px;
  --bg-1:#061018; --bg-2:#07161a;
  --card-grad: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.005));
  --muted:#98a6ad; --text:#e8f0f4; --accent:#1db954; --accent-2:#16a84a;
  --glass:rgba(255,255,255,0.03); --radius:12px; --gap:16px; --shadow:0 18px 50px rgba(2,6,10,0.6);
  font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, Arial;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text)}
.outer{display:flex;justify-content:center;padding:18px;min-height:100vh;align-items:start}
.container{width:100%;max-width:var(--max-w);display:grid;grid-template-columns: minmax(260px,380px) 1fr;gap:var(--gap);align-items:start}
.card{background:var(--card-grad);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:12px;min-height:0}
.cover-wrap{position:relative;border-radius:10px;overflow:hidden;height:min(46vh,420px);border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,#071f1a,#041018)}
.cover-img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .35s ease}
@media (min-width:920px){ .cover-wrap:hover .cover-img{transform:scale(1.03)} }
.cover-fallback{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
.cover-card{width:88%;height:88%;border-radius:8px;display:flex;align-items:center;justify-content:center}
.cover-letter{font-weight:900;color:rgba(255,255,255,0.95);font-family:Inter,Arial,Helvetica;letter-spacing:2px}
.track-meta{display:flex;flex-direction:column;gap:6px}
.title{font-weight:800;font-size:clamp(16px,2.2vw,20px);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.artist{color:var(--muted);font-size:13px}
.controls{display:flex;align-items:center;gap:12px;margin-top:6px}
.icon-btn{background:transparent;border:0;color:var(--text);padding:10px;border-radius:10px;cursor:pointer;font-size:18px;display:inline-flex;align-items:center;justify-content:center}
.play-btn{width:68px;height:68px;border-radius:14px;border:0;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#03140a;font-weight:900;font-size:18px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 10px 32px rgba(29,185,84,0.12)}
.meta-right{margin-left:auto;display:flex;gap:10px;align-items:center}
.pill{background:var(--glass);padding:8px 12px;border-radius:999px;color:var(--muted);font-size:13px;display:inline-flex;align-items:center;gap:8px}
.seek{margin-top:10px}
input[type=range]{width:100%}
input[type=range]::-webkit-slider-runnable-track{height:6px;background:linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));border-radius:6px}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;margin-top:-5px;width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 6px 12px rgba(0,0,0,0.4);cursor:pointer}
.time-row{display:flex;justify-content:space-between;color:var(--muted);font-size:13px;margin-top:6px}
.toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
.search{flex:1;background:transparent;border-radius:10px;padding:10px 12px;border:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center}
.search input{background:transparent;border:0;color:var(--text);outline:0;width:100%;font-size:14px}
.import-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:600}
.playlist{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:10px;padding:10px;overflow:auto;flex:1;box-shadow:inset 0 -30px 60px rgba(0,0,0,0.18);border:1px solid rgba(255,255,255,0.02)}
.row{display:grid;grid-template-columns:64px 1fr 84px;gap:12px;align-items:center;padding:10px;border-radius:10px;cursor:pointer;border:1px solid transparent}
.row + .row{margin-top:8px}
.row:hover{background:rgba(255,255,255,0.02);transform:translateY(-2px);transition:transform .12s,background .12s}
.row.active{background:linear-gradient(90deg, rgba(29,185,84,0.06), rgba(29,185,84,0.02));border-color:rgba(29,185,84,0.05)}
.thumb{width:64px;height:64px;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.45)}
.song-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.song-sub{font-size:13px;color:var(--muted);margin-top:6px}
.song-duration{text-align:right;color:var(--muted);font-size:13px}
.mini{position:fixed;left:18px;right:18px;bottom:18px;height:64px;background:linear-gradient(180deg,#071316,#061316);border-radius:12px;padding:10px;display:flex;align-items:center;gap:12px;box-shadow:0 18px 60px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
.mini .thumb{width:52px;height:52px;border-radius:10px;overflow:hidden}
@media (max-width:920px){ .container{grid-template-columns:1fr;gap:12px;padding:12px} .cover-wrap{height:min(42vh,320px)} .play-btn{width:56px;height:56px} .thumb{width:52px;height:52px} .card{padding:12px} }
</style>
</head>
<body>
  <div class="outer">
    <div class="container">
      <div class="card left">
        <div class="cover-wrap">
          <img id="coverImg" class="cover-img" alt="cover" />
          <div id="coverFallback" class="cover-fallback" aria-hidden="true">
            <div id="coverCard" class="cover-card" style="background:linear-gradient(180deg,#0b2a20,#051018)">
              <div id="coverLetter" class="cover-letter" style="font-size:clamp(64px,9vw,160px)">S</div>
            </div>
          </div>
        </div>

        <div class="track-meta">
          <div class="title" id="trackTitle">Loading…</div>
          <div class="artist" id="trackArtist">Siva Manihandan</div>
        </div>

        <div class="controls">
          <button class="icon-btn" id="prevBtn" title="Previous">⏮</button>
          <button class="play-btn" id="playBtn" title="Play/Pause">▶</button>
          <button class="icon-btn" id="nextBtn" title="Next">⏭</button>
          <div class="meta-right"><div class="pill" id="count">0</div></div>
        </div>

        <div class="seek">
          <input type="range" id="seek" min="0" max="100" value="0">
          <div class="time-row"><span id="curTime">0:00</span><span id="durTime">0:00</span></div>
        </div>

        <div class="settings" style="margin-top:auto">
          <div class="pill"><label style="cursor:pointer"><input id="shuffle" type="checkbox" style="margin-right:8px"> Shuffle</label></div>
          <div class="pill"><label style="cursor:pointer"><input id="repeat" type="checkbox" style="margin-right:8px"> Repeat</label></div>
          <div style="flex:1"></div>
          <div class="pill" id="autoplayChip">Autoplay</div>
        </div>
      </div>

      <div class="card right">
        <div class="toolbar">
          <div class="search"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.9;margin-right:8px"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg><input id="filter" placeholder="Search songs..." /></div>
          <div class="actions"><button id="import" class="import-btn" title="Import local mp3">Import</button></div>
        </div>

        <div class="playlist" id="playlist" role="list"></div>
      </div>
    </div>
  </div>

  <div class="mini" id="mini" style="display:none">
    <div class="thumb" id="miniThumb"><img id="miniImg" style="width:100%;height:100%;object-fit:cover"></div>
    <div class="meta">
      <div class="title" id="miniTitle">No track</div>
      <div class="artist" id="miniArtist">Siva Manihandan</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="icon-btn" id="miniPrev">⏮</button>
      <button class="play-btn" id="miniPlay" style="width:44px;height:44px;font-size:16px">▶</button>
      <button class="icon-btn" id="miniNext">⏭</button>
    </div>
  </div>

  <audio id="player" preload="metadata"></audio>

<script>
// CONFIG: point to your repo
const OWNER = 'corporationgoorac';
const REPO  = 'MP3Player-';
const BRANCH = 'main';

const AUDIO_RE = /\.mp3(\?.*)?$/i;
const DEFAULT_ARTIST = 'Siva Manihandan';

const player = document.getElementById('player');
const playlistEl = document.getElementById('playlist');
const coverImg = document.getElementById('coverImg');
const coverFallback = document.getElementById('coverFallback');
const coverLetter = document.getElementById('coverLetter');
const coverCard = document.getElementById('coverCard');
const trackTitle = document.getElementById('trackTitle');
const trackArtist = document.getElementById('trackArtist');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const seek = document.getElementById('seek');
const curTime = document.getElementById('curTime');
const durTime = document.getElementById('durTime');
const countEl = document.getElementById('count');
const filterInput = document.getElementById('filter');
const importBtn = document.getElementById('import');
const shuffleEl = document.getElementById('shuffle');
const repeatEl = document.getElementById('repeat');
const autoplayChip = document.getElementById('autoplayChip');

const mini = document.getElementById('mini');
const miniImg = document.getElementById('miniImg');
const miniTitle = document.getElementById('miniTitle');
const miniArtist = document.getElementById('miniArtist');
const miniPlay = document.getElementById('miniPlay');
const miniPrev = document.getElementById('miniPrev');
const miniNext = document.getElementById('miniNext');

let tracks = []; // {name,url,artist,thumb,duration,_blob}
let current = 0;
let isShuffle = false, isRepeat = false, autoplay = true;
player.volume = 1;

// helpers
function escapeHtml(s){ return String(s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }
function hashCode(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return h; }
function fmtTime(s){ if(isNaN(s)||!isFinite(s)) return '0:00'; const m=Math.floor(s/60); const ss=Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }

// covers
function makeThumb(name){
  const initials = (name||'').split(/[\s\-_]+/).map(t=>t[0]||'').slice(0,2).join('').toUpperCase() || 'S';
  const colors = ['#1db954','#6b8bff','#ff7a7a','#9b6bff'];
  const color = colors[Math.abs(hashCode(name)) % colors.length];
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='100%' height='100%' fill='${color}'/><text x='50%' y='56%' font-size='140' text-anchor='middle' fill='rgba(255,255,255,0.95)' font-family='Inter,Arial' font-weight='800'>${escapeHtml(initials)}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function makeCover(name){
  const letter = String((name||'').trim()[0] || 'S').toUpperCase();
  const seed = Math.abs(hashCode(name)) % 360;
  const c1 = `hsl(${seed} 58% 34%)`, c2 = `hsl(${(seed+30)%360} 54% 22%)`;
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='1024' height='1024'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='${c1}'/><stop offset='1' stop-color='${c2}'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><text x='50%' y='60%' font-size='520' text-anchor='middle' fill='rgba(255,255,255,0.94)' font-family='Inter,Arial' font-weight='900'>${escapeHtml(letter)}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function updateCoverUI(track){
  if(!track){
    coverImg.src = '';
    coverFallback.style.display = 'flex';
    coverLetter.textContent = 'S';
    coverCard.style.background = '#0b2a20';
    return;
  }
  coverImg.src = makeCover(track.name);
  coverFallback.style.display = 'none';
}
coverImg.addEventListener('error', ()=> { coverImg.src=''; coverFallback.style.display='flex'; coverLetter.textContent = (tracks[current] && tracks[current].name) ? tracks[current].name.trim()[0].toUpperCase() : 'S'; });

// render playlist
function render(filter=''){
  playlistEl.innerHTML = '';
  const filtered = tracks.filter(t => (t.name + ' ' + (t.artist||'')).toLowerCase().includes(filter.toLowerCase()));
  filtered.forEach((t) => {
    const i = tracks.indexOf(t);
    const row = document.createElement('div');
    row.className = 'row' + (i === current ? ' active' : '');
    row.dataset.index = i;
    row.innerHTML = `
      <div class="thumb"><img src="${t.thumb}" alt=""></div>
      <div>
        <div class="song-title">${escapeHtml(t.name)}</div>
        <div class="song-sub">${escapeHtml(t.artist || DEFAULT_ARTIST)}</div>
      </div>
      <div class="song-duration">${t.duration ? fmtTime(t.duration) : ''}</div>
    `;
    row.addEventListener('click', ()=> playIndex(i));
    playlistEl.appendChild(row);
  });
  countEl.textContent = tracks.length;
  updateMini();
}

// metadata & media session
function setMeta(t){
  trackTitle.textContent = t ? t.name : 'No track';
  trackArtist.textContent = t ? (t.artist || DEFAULT_ARTIST) : DEFAULT_ARTIST;
  updateCoverUI(t);
  if('mediaSession' in navigator && t){
    try{ navigator.mediaSession.metadata = new MediaMetadata({ title: t.name, artist: t.artist || DEFAULT_ARTIST, album: 'Local', artwork: [{src: t.thumb, sizes:'512x512'}] }); }catch(e){}
  }
}

// play controls
function playIndex(i){
  if(tracks.length === 0) return;
  if(i < 0) i = 0;
  if(i >= tracks.length) i = 0;
  current = i;
  const t = tracks[current];
  player.src = t.url;
  setMeta(t);
  player.play().catch(()=>{});
  render(filterInput.value);
}
function playNext(){
  if(isRepeat){ player.currentTime = 0; player.play(); return; }
  if(isShuffle){ playIndex(Math.floor(Math.random()*tracks.length)); return; }
  playIndex((current + 1) % tracks.length);
}
function playPrev(){
  if(player.currentTime > 3){ player.currentTime = 0; player.play(); return; }
  playIndex(Math.max(0, current - 1));
}

// events
player.addEventListener('timeupdate', ()=> {
  if(player.duration){
    seek.value = (player.currentTime / player.duration) * 100;
    curTime.textContent = fmtTime(player.currentTime);
    durTime.textContent = fmtTime(player.duration);
  }
});
player.addEventListener('loadedmetadata', ()=> {
  if(player.duration && tracks[current]){ tracks[current].duration = player.duration; render(filterInput.value); }
});
player.addEventListener('ended', ()=> { if(autoplay) playNext(); else { playBtn.textContent='▶'; miniPlay.textContent='▶'; } });
seek.addEventListener('input', ()=> { if(player.duration) player.currentTime = (seek.value/100) * player.duration; });

// UI handlers
playBtn.addEventListener('click', ()=>{
  if(!player.src && tracks.length) { playIndex(0); return; }
  if(player.paused){ player.play(); playBtn.textContent='⏸'; miniPlay.textContent='⏸'; }
  else { player.pause(); playBtn.textContent='▶'; miniPlay.textContent='▶'; }
});
prevBtn.addEventListener('click', playPrev);
nextBtn.addEventListener('click', playNext);
miniPrev.addEventListener('click', e=>{ e.stopPropagation(); playPrev(); });
miniNext.addEventListener('click', e=>{ e.stopPropagation(); playNext(); });
miniPlay.addEventListener('click', e=>{ e.stopPropagation(); playBtn.click(); });

shuffleEl.addEventListener('change', ()=> isShuffle = shuffleEl.checked);
repeatEl.addEventListener('change', ()=> isRepeat = repeatEl.checked);

// mini
function updateMini(){
  const t = tracks[current];
  if(!t){ mini.style.display = 'none'; return; }
  mini.style.display = 'flex';
  miniTitle.textContent = t.name;
  miniArtist.textContent = t.artist || DEFAULT_ARTIST;
  miniImg.src = t.thumb;
  const paused = player.paused || !player.src;
  miniPlay.textContent = paused ? '▶' : '⏸';
  playBtn.textContent = paused ? '▶' : '⏸';
}

// keyboard
document.addEventListener('keydown', e=> { const tag=document.activeElement&&document.activeElement.tagName.toLowerCase(); if(tag==='input'||tag==='textarea') return; if(e.code==='Space'){ e.preventDefault(); playBtn.click(); } if(e.code==='ArrowRight') nextBtn.click(); if(e.code==='ArrowLeft') prevBtn.click(); });

// import local
importBtn.addEventListener('click', ()=> {
  const inp = document.createElement('input'); inp.type='file'; inp.multiple=true; inp.accept='.mp3';
  inp.onchange = async ()=> {
    if(!inp.files) return;
    const files = Array.from(inp.files).filter(f => AUDIO_RE.test(f.name));
    if(!files.length) return;
    tracks.forEach(t=> { if(t._blob) URL.revokeObjectURL(t.url); });
    tracks = files.map(f => ({ name: f.name.replace(/\.[^/.]+$/,''), url: URL.createObjectURL(f), artist: DEFAULT_ARTIST, _blob:true, thumb: makeThumb(f.name.replace(/\.[^/.]+$/,'')) }));
    await populateDurations();
    render(''); if(tracks.length) playIndex(0);
  };
  inp.click();
});

// durations helper
async function populateDurations(){
  const promises = tracks.map(t => new Promise(resolve => {
    if(t.duration && !isNaN(t.duration)) return resolve(t);
    const a = document.createElement('audio'); a.preload='metadata'; a.src = t.url;
    const tidy = ()=> { try{ a.remove(); }catch(e){} };
    const onmeta = ()=> { if(!isNaN(a.duration) && isFinite(a.duration)) t.duration = a.duration; tidy(); resolve(t); };
    const onerr = ()=> { tidy(); resolve(t); };
    a.addEventListener('loadedmetadata', onmeta, {once:true}); a.addEventListener('error', onerr, {once:true}); a.load();
    setTimeout(()=> { resolve(t); try{ a.remove(); }catch(e){} }, 6000);
  }));
  await Promise.all(promises);
}

// Robust loader with diagnostics
async function loadFromGithub(){
  const setStatus = (s) => { try{ trackTitle.textContent = s; console.log('[player-status]', s); }catch(e){} };
  setStatus('Checking GitHub…');

  try{
    const api = `https://api.github.com/repos/${OWNER}/${REPO}/contents/?ref=${BRANCH}`;
    console.log('[loader] calling GitHub contents API:', api);
    const res = await fetch(api, { headers: { 'Accept': 'application/vnd.github.v3+json' }});
    if(res.status === 404){
      setStatus('Repo or branch not found (404). Check OWNER/REPO/BRANCH.');
      console.error('[loader] GitHub contents API 404', api);
      return;
    }
    if(res.status === 403){
      const txt = await res.text();
      setStatus('GitHub API rate-limited or access denied (403). Check console.');
      console.error('[loader] GitHub API 403 — possible rate limit or auth required', txt);
      return;
    }
    if(!res.ok){
      const body = await res.text();
      setStatus(`GitHub API error ${res.status}`);
      console.error('[loader] GitHub API error', res.status, body);
      return;
    }

    const json = await res.json();
    if(!Array.isArray(json)){
      setStatus('Unexpected GitHub response format.');
      console.error('[loader] unexpected contents API response', json);
      return;
    }

    const mp3items = json.filter(i => i.type === 'file' && /\.mp3(\?.*)?$/i.test(i.name));
    console.log('[loader] mp3items found:', mp3items.length, mp3items.map(x=>x.name));

    if(mp3items.length === 0){
      setStatus('No .mp3 files found in repo root.');
      return;
    }

    setStatus(`Found ${mp3items.length} tracks — verifying...`);

    const verified = [];
    for(const item of mp3items){
      const download = item.download_url;
      const encoded = download.replace(/ /g, '%20');
      let ok =
