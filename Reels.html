<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoidUpLift Reels Editor Pro</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Anton&family=Bebas+Neue&family=Playfair+Display&family=Oswald&family=Pacifico&family=Cinzel&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
*{ box-sizing:border-box; margin:0; padding:0; }
body{ background:#000; color:#fff; font-family:Poppins, sans-serif; height:100vh; overflow:hidden; }
.app{ display:flex; flex-direction:column; height:100vh; }
.preview{ display:flex; flex-direction:column; align-items:center; padding:10px; background: #0a0a0a; }
canvas{ width:48vw; max-width:220px; aspect-ratio:9/16; border-radius:16px; border:2px solid #333; background:#000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
.play{ font-size:32px; margin-top:10px; cursor:pointer; color: #00ff88; }
.iconbar{ display:flex; justify-content:space-around; padding:12px; border-top:1px solid #222; background:#050505; }
.iconbar span{ font-size:28px; cursor:pointer; transition: 0.2s; }
.iconbar span:hover{ color: #00ff88; }
.controls{ flex:1; background:#050505; overflow-y:auto; padding:15px; border-top: 1px solid #222; }
.panel{ display:none; }
.panel.active{ display:block; }
textarea, input, select{ width:100%; background:#111; border:1px solid #333; color:#fff; padding:12px; margin-bottom:12px; border-radius: 8px; }
textarea{ height:80px; resize: none; }
label{ font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 5px; }
.status{ text-align:center; font-size:13px; color:#00ff88; padding:8px; background: #111; border-radius: 5px; margin-top: 5px; font-weight: bold; }
input[type="range"] { accent-color: #00ff88; }
.checkbox-group { display: flex; gap: 15px; margin-bottom: 15px; }
.checkbox-group label { display: flex; align-items: center; gap: 5px; text-transform: none; color: #fff; font-size: 14px; }
</style>
</head>

<body>
<div class="app">
  <div class="preview">
    <canvas id="canvas" width="1080" height="1920"></canvas>
    <span id="playBtn" class="material-icons play">play_arrow</span>
    <input type="range" id="timeline" min="0" max="10" step="0.01" style="width: 80%;">
  </div>

  <div class="iconbar">
    <span class="material-icons" onclick="openPanel('textP')">text_fields</span>
    <span class="material-icons" onclick="openPanel('fontP')">font_download</span>
    <span class="material-icons" onclick="openPanel('imgP')">image</span>
    <span class="material-icons" onclick="openPanel('audioP')">music_note</span>
    <span class="material-icons" onclick="exportVideo()" style="color:#00ff88">file_download</span>
  </div>

  <div class="controls">
    <div id="textP" class="panel active">
      <label>Content</label>
      <textarea id="text" placeholder="Type your message..."></textarea>
      
      <div class="checkbox-group">
        <label><input type="checkbox" id="typeEffect"> Typing</label>
        <label><input type="checkbox" id="textOutline"> Outline</label>
      </div>

      <label>Typing Speed</label>
      <input type="range" id="typingSpeedInput" min="5" max="100" value="25">

      <label>Animation Style</label>
      <select id="textAnim">
        <option value="fade">Smooth Fade</option>
        <option value="slideUp">Slide Up</option>
        <option value="slideLeft">Slide Left</option>
        <option value="zoom">Elastic Zoom</option>
        <option value="bounce">Bouncy Loop</option>
        <option value="blur">Blur Transition</option>
      </select>

      <label>Font Size</label>
      <input type="range" id="sizeInput" min="20" max="200" value="80">
      
      <label>Text Color</label>
      <input type="color" id="colorInput" value="#ffffff">
    </div>

    <div id="fontP" class="panel">
      <label>Choose Style</label>
      <select id="fontSelect">
        <option value="Poppins">Poppins (Modern)</option>
        <option value="Anton">Anton (Bold)</option>
        <option value="Bebas Neue">Bebas Neue (Impact)</option>
        <option value="Playfair Display">Playfair (Elegant)</option>
        <option value="Oswald">Oswald (Narrow)</option>
        <option value="Pacifico">Pacifico (Script)</option>
        <option value="Cinzel">Cinzel (Classic)</option>
      </select>
    </div>

    <div id="imgP" class="panel">
      <label>Background Image</label>
      <input type="file" id="imgInput" accept="image/*">
      <label>Video Duration (Seconds)</label>
      <input type="number" id="durationInput" value="10" min="1" max="60">
    </div>

    <div id="audioP" class="panel">
      <label>Background Music</label>
      <input type="file" id="audioInput" accept="audio/*">
    </div>

    <div class="status" id="status">Ready to Edit</div>
  </div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d",{alpha:false});
const timeline = document.getElementById("timeline");

let img = new Image();
let audio = null;
let txt = "Your Text Here";
let activeFont = "Poppins";
let activeSize = 80;
let activeColor = "#ffffff";
let typingSpeed = 25;
let hasOutline = false;

let duration = 10;
let tx = 100; ty = 400;
let typing = false;
let textAnim = "fade";
let startFadeDuration = 1.0;
let endCreditDuration = 2.0;
let dragging = false;
let playing = false;
let time = 0;
let last = 0;

function liveDraw(){ draw(time); }

// UI LISTENERS
document.getElementById("imgInput").onchange = e => { if(e.target.files[0]) { img.src = URL.createObjectURL(e.target.files[0]); img.onload = liveDraw; } };
document.getElementById("audioInput").onchange = e => { if(e.target.files[0]) audio = new Audio(URL.createObjectURL(e.target.files[0])); };
document.getElementById("text").oninput = e => { txt = e.target.value; liveDraw(); };
document.getElementById("fontSelect").onchange = e => { activeFont = e.target.value; liveDraw(); };
document.getElementById("sizeInput").oninput = e => { activeSize = parseInt(e.target.value); liveDraw(); };
document.getElementById("colorInput").oninput = e => { activeColor = e.target.value; liveDraw(); };
document.getElementById("typingSpeedInput").oninput = e => { typingSpeed = parseInt(e.target.value); liveDraw(); };
document.getElementById("textAnim").onchange = e => { textAnim = e.target.value; liveDraw(); };
document.getElementById("typeEffect").onchange = e => { typing = e.target.checked; liveDraw(); };
document.getElementById("textOutline").onchange = e => { hasOutline = e.target.checked; liveDraw(); };
document.getElementById("durationInput").oninput = e => { 
    duration = Math.max(1, +e.target.value); 
    timeline.max = duration; 
    liveDraw(); 
};
timeline.oninput = e => { time = +e.target.value; liveDraw(); };

function openPanel(id){
  document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// DRAG SYSTEM
canvas.onpointerdown = ()=> dragging = true;
canvas.onpointerup = ()=> dragging = false;
canvas.onpointermove = e => {
  if(!dragging) return;
  const r = canvas.getBoundingClientRect();
  tx = (e.clientX - r.left) * (1080 / r.width);
  ty = (e.clientY - r.top) * (1920 / r.height);
  liveDraw();
};

function wrapText(text,x,y,max,lineHeight){
  let words = text.split(" ");
  let line = "";
  for(let w of words){
    let test = line + w + " ";
    if(ctx.measureText(test).width > max){
      if(hasOutline){ ctx.strokeText(line,x,y); }
      ctx.fillText(line,x,y);
      line = w + " ";
      y += lineHeight;
    } else { line = test; }
  }
  if(hasOutline){ ctx.strokeText(line,x,y); }
  ctx.fillText(line,x,y);
}

function draw(t){
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = "high";
  ctx.clearRect(0,0,1080,1920);

  // 1. END CREDITS LOGIC
  if(t >= duration - endCreditDuration){
    let alpha = Math.min(1,(t-(duration-endCreditDuration)));
    ctx.globalAlpha = alpha; ctx.fillStyle = "#000"; ctx.fillRect(0,0,1080,1920);
    ctx.fillStyle = "#fff"; ctx.font = "bold 90px Poppins"; ctx.textAlign = "center";
    ctx.fillText("VOID UPLIFT",540,960); ctx.globalAlpha = 1; return;
  }

  // 2. BACKGROUND
  ctx.fillStyle = "#000"; ctx.fillRect(0,0,1080,1920);
  let startAlpha = Math.min(1, t / startFadeDuration);

  if(img.width){
    let s = 1080 / img.width; let h = img.height * s; let yPos = (1920 - h) / 2;
    ctx.globalAlpha = startAlpha; ctx.drawImage(img,0,yPos,1080,h);
  }

  // 3. TEXT ENGINE
  ctx.fillStyle = activeColor;
  ctx.font = activeSize + "px " + activeFont;
  ctx.textAlign = "left";
  ctx.globalAlpha = startAlpha;
  
  if(hasOutline){
    ctx.strokeStyle = "#000";
    ctx.lineWidth = activeSize / 10;
    ctx.lineJoin = "round";
  }

  let displayTxt = typing ? txt.substring(0, Math.floor(t * typingSpeed)) : txt;
  let x = tx; let y = ty;

  // ANIMATION ENGINE
  if(textAnim === "slideUp") y += (1-startAlpha)*100;
  if(textAnim === "slideLeft") x -= (1-startAlpha)*100;
  if(textAnim === "zoom"){
    ctx.save(); ctx.translate(x,y); ctx.scale(0.7+startAlpha*0.3, 0.7+startAlpha*0.3);
    wrapText(displayTxt,0,0,880,activeSize+20); ctx.restore(); return;
  }
  if(textAnim === "bounce") y += Math.sin(t * 5) * 25;
  if(textAnim === "blur") { ctx.shadowColor = activeColor; ctx.shadowBlur = (1-startAlpha)*50; }

  wrapText(displayTxt,x,y,880,activeSize+20);
  ctx.shadowBlur = 0; ctx.globalAlpha = 1;
}

// LIVE PLAYBACK
playBtn.onclick = ()=>{
  playing = !playing;
  playBtn.textContent = playing ? "pause" : "play_arrow";
  if(audio) { playing ? (audio.currentTime = time, audio.play()) : audio.pause(); }
  if(playing){ last = performance.now(); requestAnimationFrame(playLoop); }
};

function playLoop(n){
  if(!playing) return;
  time += (n - last) / 1000;
  last = n; timeline.value = time; draw(time);
  if(time >= duration){
    playing = false; playBtn.textContent = "play_arrow";
    if(audio) audio.pause(); return;
  }
  requestAnimationFrame(playLoop);
}

/* ============================================================
   FIXED: DETERMINISTIC EXPORT (PRECISE SECONDS)
============================================================ */
async function exportVideo(){
  // Safety: Stop any current preview
  playing = false;
  if(audio) audio.pause();
  playBtn.textContent = "play_arrow";

  status.textContent = "Preparing High Quality Render...";
  
  const fps = 30;
  const totalFrames = Math.floor(duration * fps);
  let currentFrame = 0;

  const stream = canvas.captureStream(fps);

  // Capture Audio Track
  if(audio){
    const ac = new AudioContext();
    const src = ac.createMediaElementSource(audio);
    const dst = ac.createMediaStreamDestination();
    src.connect(dst);
    src.connect(ac.destination);
    dst.stream.getTracks().forEach(t=>stream.addTrack(t));
    audio.currentTime = 0;
    audio.play();
  }

  const recorder = new MediaRecorder(stream,{ 
    mimeType:"video/webm;codecs=vp9", 
    videoBitsPerSecond: 20000000 // 20Mbps High Definition
  });

  const chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.start();

  // THE KEY FIX: Render every frame manually
  function renderStep() {
    if(currentFrame <= totalFrames) {
      const renderTime = currentFrame / fps;
      draw(renderTime); // Render specific timestamp
      
      // Update UI
      const percent = Math.floor((currentFrame / totalFrames) * 100);
      status.textContent = `Rendering: ${percent}%`;

      currentFrame++;
      requestAnimationFrame(renderStep);
    } else {
      recorder.stop();
    }
  }

  renderStep();

  recorder.onstop = ()=>{
    if(audio) audio.pause();
    const blob = new Blob(chunks,{type:"video/webm"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `VoidUpLift_${duration}s.webm`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    status.textContent = "Export Successful!";
    setTimeout(() => { status.textContent = "Ready to Edit"; }, 3000);
  };
}
</script>
</body>
</html>
